# Add UAA Release
- type: replace
  path: /releases/-
  value:
    name: uaa
    version: "52.4"
    url: https://s3.amazonaws.com/bosh-compiled-release-tarballs/uaa-52.4-ubuntu-trusty-3468.13-20171209-003153-486864753-20171209003200.tgz?versionId=_NrqFWkxlSlVlaoZR5nSZRzKhEdu.qN3
    sha1: 09a83ee0dff8a7791f99cd2261a92b38cc5001ff

# Add UAA job
- type: replace
  path: /instance_groups/name=uaa?/jobs?/-
  value:
    name: uaa
    release: uaa
    properties:
      uaa:
        url: "https://((lb_ip)):8443"
        sslPrivateKey: ((concourse_ssl.private_key))
        sslCertificate: ((concourse_ssl.certificate))
        require_https: false
        jwt:
          signing_key: ((uaa_jwt_signing_key.private_key))
          verification_key: ((uaa_jwt_signing_key.public_key))
        scim:
          users:
          - name: admin
            groups: [concourse]
            password: ((admin_password))
        clients:
          concourse:
            override: true
            authorized-grant-types: authorization_code,refresh_token
            autoapprove: true
            redirect-uri: https://((lb_ip))/auth/oauth/callback
            scope: concourse
            authorities: ""
            secret: ((concourse_client_secret))
          uaa_admin:
            override: true
            authorized-grant-types: client_credentials
            scope: ""
            authorities: clients.read,clients.write,clients.secret,uaa.admin,scim.read,scim.write,password.write
            secret: ((uaa_admin_client_secret))
        login: {client_secret: ((uaa_login_client_secret))}
        zones:
          internal:
            hostnames:
            - ((lb_ip))
            - 127.0.0.1
      login:
        self_service_links_enabled: false
        saml:
          serviceProviderKey: ((uaa_service_provider_ssl.private_key))
          serviceProviderKeyPassword: "" # TODO: Remove this when UAA defaults this value
          serviceProviderCertificate: ((uaa_service_provider_ssl.certificate))
      uaadb:
        address: 127.0.0.1
        port: 5432
        db_scheme: postgresql
        databases:
        - tag: uaa
          name: uaa
        roles:
        - tag: admin
          name: uaa
          password: ((uaa_db_password))

# Add database
- type: replace
  path: /instance_groups/name=concourse/jobs/name=postgres/properties/databases/databases/-
  value:
    name: uaa

- type: replace
  path: /instance_groups/name=concourse/jobs/name=postgres/properties/databases/roles/-
  value:
    name: uaa
    password: ((uaa_db_password))

# Switch Concourse to use UAA
- type: replace
  path: /instance_groups/name=concourse/jobs/name=atc/properties/generic_oauth?
  value:
    auth_url: https://((lb_ip)):8443/oauth/authorize
    client_id: concourse
    client_secret: ((concourse_client_secret))
    display_name: UAA
    scope: concourse
    token_url: http://127.0.0.1:8080/oauth/token

# Variables
- type: replace
  path: /variables/-
  value:
    name: uaa_jwt_signing_key
    type: rsa

- type: replace
  path: /variables/-
  value:
    name: uaa_admin_client_secret
    type: password

- type: replace
  path: /variables/-
  value:
    name: uaa_login_client_secret
    type: password

- type: replace
  path: /variables/-
  value:
    name: admin_password
    type: password

- type: replace
  path: /variables/-
  value:
    name: concourse_client_secret
    type: password

- type: replace
  path: /variables/-
  value:
    name: uaa_db_password
    type: password

- type: replace
  path: /variables/-
  value:
    name: uaa_service_provider_ssl
    type: certificate
    options:
      ca: default_ca
      common_name: ((internal_ip))
      alternative_names: [((internal_ip))]
